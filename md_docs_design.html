<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>node-addon-layer: Module Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">node-addon-layer
   </div>
   <div id="projectbrief">C API For writing Node modules</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Module Design </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>By writing a native module you are explicitly preventing that logic from being optimized by the JIT, it will only be as optimized as the target compiler provides. So things like function inlining and lookup caching can't be done by the JIT for logic defined in C.</p>
<p>There is a cost for a boundary jump between JavaScript and C, and it is more than the cost of a function call in pure JavaScript (espcially if the JIT inlined the call). But while the boundary cost is measurable, it is more expensive to actually mutate an object (i.e. set properties) in C compared to mutating the object in JavaScript.</p>
<p>To that end it is important to try and interact with your module using primitives, like:</p>
<ul>
<li><a href="group__numbers.html">Integer, Number</a></li>
<li><a href="group__strings.html">String</a></li>
<li><a href="group__buffers.html">Buffer</a></li>
<li><a href="group__externals.html">External</a></li>
<li><a href="group__functions.html">Function</a></li>
</ul>
<p>That is, you should pass and return these primitves. You can pass and return an object, but don't modify the object in a hot path. If you want to construct an object in a hot path it is generally cheaper to also pass a function to create and return that object:</p>
<div class="fragment"><div class="line"><a class="code" href="group__core.html#gaab77202d0d00070f145e35d1299b0697">shim_bool_t</a></div>
<div class="line">do_something(<a class="code" href="group__core.html#ga01debe564a9759f12e6e89d300b07c9e">shim_ctx_t</a>* ctx, <a class="code" href="group__core.html#ga7ac61a620e8b04007a7ed3445b6c76c1">shim_args_t</a>* args)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* grab the first argument */</span></div>
<div class="line">  <a class="code" href="group__core.html#ga11881607db69d18ac533345a1f5d40e2">shim_val_t</a>* blah = <a class="code" href="group__arguments.html#ga247eaf9586d35691a15bf19fa4cac08d">shim_args_get</a>(args, 0);</div>
<div class="line">  <span class="comment">/* grab the second argument which is the callback */</span></div>
<div class="line">  <a class="code" href="group__core.html#ga11881607db69d18ac533345a1f5d40e2">shim_val_t</a>* factory = <a class="code" href="group__arguments.html#ga247eaf9586d35691a15bf19fa4cac08d">shim_args_get</a>(args, 1);</div>
<div class="line">  <span class="comment">/* alloc space for the return value */</span></div>
<div class="line">  <a class="code" href="group__core.html#ga11881607db69d18ac533345a1f5d40e2">shim_val_t</a>* rval = malloc(<span class="keyword">sizeof</span>(<a class="code" href="group__core.html#ga11881607db69d18ac533345a1f5d40e2">shim_val_t</a>*));</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* construct the set of arguments to be passed to the callback */</span></div>
<div class="line">  <a class="code" href="group__core.html#ga11881607db69d18ac533345a1f5d40e2">shim_val_t</a>* argv[] = {</div>
<div class="line">    <a class="code" href="group__numbers.html#ga07978a098ba6c9345724701518decde3">shim_integer_new</a>(ctx, 10),</div>
<div class="line">    <a class="code" href="group__strings.html#gaade4cd8781f011aa3e6e7f9c3de85485">shim_string_new_copy</a>(ctx, <span class="stringliteral">&quot;baz&quot;</span>),</div>
<div class="line">    <a class="code" href="group__primitives.html#ga5225847a20539a37dbaa7e7f3b94081b">shim_undefined</a>(),</div>
<div class="line">  };</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* call the callback without specifying a `this` for the function */</span></div>
<div class="line">  <a class="code" href="group__core.html#gaab77202d0d00070f145e35d1299b0697">shim_bool_t</a> = <a class="code" href="group__functions.html#ga03c52c0b740d32d855a47b8e95a3f59a">shim_func_call_val</a>(ctx, NULL, factory, 3, argv, ret);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * we only want to release the values we&#39;ve created, incoming arguments</span></div>
<div class="line"><span class="comment">   * don&#39;t need released because the addon layer handles those for us</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)</div>
<div class="line">    <a class="code" href="group__primitives.html#gab5409cb002417a0324b1ca43b41c4dd2">shim_value_release</a>(argv[i]);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (ret) {</div>
<div class="line">    <span class="comment">/* the callback was fine, use its return value */</span></div>
<div class="line">    <a class="code" href="group__arguments.html#ga2d273b98a97af9e849456d2b0748aa41">shim_args_set_rval</a>(ctx, args, rval);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* the callback failed, don&#39;t leak memory */</span></div>
<div class="line">    <a class="code" href="group__primitives.html#gab5409cb002417a0324b1ca43b41c4dd2">shim_value_release</a>(rval);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --><p>And then in JavaScript</p>
<div class="fragment"><div class="line"><span class="keyword">function</span> createObj(a, b, c) {</div>
<div class="line">  <span class="keywordflow">return</span> {</div>
<div class="line">    foo: a,</div>
<div class="line">    bar: b,</div>
<div class="line">    baz: c,</div>
<div class="line">  };</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">var myObj = module.do_something(<span class="stringliteral">&#39;foobarbaz&#39;</span>, createObj);</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 7 2013 15:17:55 for node-addon-layer by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.4
</small></address>
</body>
</html>
